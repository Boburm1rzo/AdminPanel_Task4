@page
@model UsersModel
@using Task4.Models

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="~/css/users.css?v=3" type="text/css" />

<div class="users-page container-fluid px-4 py-4">
    <div class="users-header">
        <div class="users-title">
            <h2 class="fw-bold mb-1">
                <i class="bi bi-people-fill me-2"></i>Users Management
            </h2>
            <p class="text-muted mb-0">Manage and monitor user accounts</p>
        </div>

        <div class="users-count">
            <span class="badge bg-primary fs-6 px-3 py-2">
                Total Users: @Model.Users.Count
            </span>
        </div>
    </div>

    <form method="post">
        <div class="card shadow-sm border-0 mb-3 users-toolbar">
            <div class="card-body">
                <div class="toolbar-row">
                    <div class="toolbar-actions">
                        <button type="submit"
                                asp-page-handler="UpdateStatus"
                                name="status"
                                value="Blocked"
                                class="btn btn-outline-primary d-flex align-items-center px-3 btn-pill">
                            <i class="bi bi-lock-fill me-2"></i><span>Block</span>
                        </button>

                        <button type="submit"
                                asp-page-handler="UpdateStatus"
                                name="status"
                                value="Active"
                                class="btn btn-outline-primary btn-icon btn-pill"
                                title="Unblock">
                            <i class="bi bi-unlock-fill"></i>
                        </button>

                        <button type="button"
                                class="btn btn-outline-danger btn-icon btn-pill"
                                onclick="deleteSelected();"
                                title="Delete selected">
                            <i class="bi bi-trash-fill"></i>
                        </button>

                        <button type="submit"
                                asp-page-handler="ClearUnverified"
                                class="btn btn-outline-secondary btn-icon btn-pill"
                                onclick="OnPostClearUnverified();"
                                title="Delete all unverified users">
                            <i class="bi bi-person-x-fill"></i>
                        </button>
                    </div>

                    <div class="toolbar-filter">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-funnel-fill"></i>
                            </span>
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Blocked">Blocked</option>
                                <option value="Unverified">Unverified</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 users-table-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="usersTable">
                        <thead class="table-light">
                            <tr>
                                <th class="col-select text-center">
                                    <input type="checkbox"
                                           id="selectAll"
                                           class="form-check-input"
                                           style="width: 20px; height: 20px; cursor: pointer;" />
                                </th>

                                <th class="col-name">
                                    <a class="sort-link"
                                       asp-page="./Users"
                                       asp-route-sort="name"
                                       asp-route-dir="@Model.NextDir("name")">
                                        Name <i class="bi @Model.SortIcon("name")"></i>
                                    </a>
                                </th>

                                <th class="col-email">
                                    <a class="sort-link"
                                       asp-page="./Users"
                                       asp-route-sort="email"
                                       asp-route-dir="@Model.NextDir("email")">
                                        Email <i class="bi @Model.SortIcon("email")"></i>
                                    </a>
                                </th>

                                <th class="col-status text-center">
                                    Status
                                </th>

                                <th class="col-lastseen">
                                    <a class="sort-link"
                                       asp-page="./Users"
                                       asp-route-sort="lastseen"
                                       asp-route-dir="@Model.NextDir("lastseen")">
                                        Last Seen <i class="bi @Model.SortIcon("lastseen")"></i>
                                    </a>
                                </th>

                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var user in Model.Users)
                            {
                                var statusClass = user.Status == UserStatus.Active ? "Active" :
                                user.Status == UserStatus.Blocked ? "Blocked" : "Unverified";

                                var timeDiff = DateTime.UtcNow - user.LastSeen;
                                var totalMinutes = (int)timeDiff.TotalMinutes;

                                string displayTime;
                                if (totalMinutes < 1) displayTime = "less than a minute ago";
                                else if (totalMinutes < 60) displayTime = $"{totalMinutes} minute{(totalMinutes == 1 ? "" : "s")} ago";
                                else if (totalMinutes < 1440) displayTime = $"{totalMinutes / 60} hour{(totalMinutes / 60 == 1 ? "" : "s")} ago";
                                else if (totalMinutes < 10080) displayTime = $"{totalMinutes / 1440} day{(totalMinutes / 1440 == 1 ? "" : "s")} ago";
                                else displayTime = $"{totalMinutes / 10080} week{(totalMinutes / 10080 == 1 ? "" : "s")} ago";

                                var tooltipDate = user.LastSeen.ToString("MMMM dd, yyyy HH:mm:ss");

                                <tr data-status="@statusClass">
                                    <td class="col-select text-center">
                                        <input type="checkbox"
                                               name="selectedUserIds"
                                               value="@user.Id"
                                               class="form-check-input user-checkbox"
                                               style="width: 20px; height: 20px; cursor: pointer;" />
                                    </td>

                                    <td class="col-name">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-2 flex-shrink-0">
                                                @user.Name.Substring(0, 1).ToUpper()
                                            </div>
                                            <div class="min-w-0">
                                                <div class="fw-semibold text-truncate">@user.Name</div>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="col-email">
                                        <div class="text-muted text-truncate">@user.Email</div>
                                    </td>

                                    <td class="col-status text-center">
                                        @if (user.Status == UserStatus.Active)
                                        {
                                            <span class="badge bg-success px-3 py-2">
                                                <i class="bi bi-check-circle-fill me-1"></i>Active
                                            </span>
                                        }
                                        else if (user.Status == UserStatus.Blocked)
                                        {
                                            <span class="badge bg-danger px-3 py-2">
                                                <i class="bi bi-x-circle-fill me-1"></i>Blocked
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark px-3 py-2">
                                                <i class="bi bi-exclamation-circle-fill me-1"></i>Unverified
                                            </span>
                                        }
                                    </td>

                                    <td class="col-lastseen">
                                        <div class="lastseen-cell">
                                            <div class="lastseen-text">@displayTime</div>

                                            <div class="bar-chart-container"
                                                 data-bs-toggle="tooltip"
                                                 data-bs-placement="top"
                                                 title="@tooltipDate">
                                                @{
                                                    var random = new Random(user.Id);
                                                    var bars = new List<int>();
                                                    for (int i = 0; i < 8; i++) { bars.Add(random.Next(30, 100)); }
                                                }
                                                <div class="bars">
                                                    @foreach (var height in bars)
                                                    {
                                                        <div class="bar" style="height: @(height)%;"></div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (!Model.Users.Any())
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">No users found</p>
                    </div>
                }
            </div>
        </div>

        <div class="users-cards">
            @foreach (var user in Model.Users)
            {
                var statusClass = user.Status == UserStatus.Active ? "Active" :
                user.Status == UserStatus.Blocked ? "Blocked" : "Unverified";

                var timeDiff = DateTime.UtcNow - user.LastSeen;
                var totalMinutes = (int)timeDiff.TotalMinutes;

                string displayTime;
                if (totalMinutes < 1) displayTime = "less than a minute ago";
                else if (totalMinutes < 60) displayTime = $"{totalMinutes} minute{(totalMinutes == 1 ? "" : "s")} ago";
                else if (totalMinutes < 1440) displayTime = $"{totalMinutes / 60} hour{(totalMinutes / 60 == 1 ? "" : "s")} ago";
                else if (totalMinutes < 10080) displayTime = $"{totalMinutes / 1440} day{(totalMinutes / 1440 == 1 ? "" : "s")} ago";
                else displayTime = $"{totalMinutes / 10080} week{(totalMinutes / 10080 == 1 ? "" : "s")} ago";

                var tooltipDate = user.LastSeen.ToString("MMMM dd, yyyy HH:mm:ss");

                <div class="user-card" data-status="@statusClass">
                    <div class="card-top">
                        <label class="check">
                            <input type="checkbox"
                                   name="selectedUserIds"
                                   value="@user.Id"
                                   class="form-check-input user-checkbox" />
                        </label>

                        <div class="avatar-circle">@user.Name.Substring(0, 1).ToUpper()</div>

                        <div class="card-main">
                            <div class="name text-truncate">@user.Name</div>
                            <div class="email text-truncate">@user.Email</div>
                        </div>

                        <div class="status">
                            @if (user.Status == UserStatus.Active)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Active</span>
                            }
                            else if (user.Status == UserStatus.Blocked)
                            {
                                <span class="badge bg-danger"><i class="bi bi-x-circle-fill me-1"></i>Blocked</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle-fill me-1"></i>Unverified</span>
                            }
                        </div>
                    </div>

                    <div class="card-bottom">
                        <div class="lastseen">
                            <i class="bi bi-clock me-1"></i>
                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="@tooltipDate">
                                @displayTime
                            </span>
                        </div>

                        <div class="mini-bars" aria-hidden="true">
                            @{
                                var random = new Random(user.Id);
                                var bars = new List<int>();
                                for (int i = 0; i < 8; i++) { bars.Add(random.Next(30, 100)); }
                            }
                            @foreach (var height in bars)
                            {
                                <div class="bar" style="height: @(height)%;"></div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </form>
</div>

<script src="~/js/users.js"></script>
