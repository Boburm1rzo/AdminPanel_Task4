name: Deploy to VPS

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}

          command_timeout: 30m
          script_stop: true

          script: |
            set -euo pipefail

            echo "== Go to project folder =="
            SERVER_PATH="/root/projects/task4/AdminPanel_Task4/Task4/Task4"
            APP_URL="http://127.0.0.1:8080"

            cd "$SERVER_PATH"

            echo "== Update repository =="
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "== Create .env file from GitHub Secrets =="
            cat > .env << EOF
            EMAIL_HOST=${{ secrets.EMAIL_HOST }}
            EMAIL_PORT=${{ secrets.EMAIL_PORT }}
            EMAIL_FROM=${{ secrets.EMAIL_FROM }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            EOF

            echo "== Build & Restart Docker containers =="
            docker compose down
            docker compose up -d --build

            echo "== Health Check (max 20s) =="
            for i in {1..20}; do
              if curl -fsS "$APP_URL/health" >/dev/null 2>&1; then
                echo "✅ Deploy successful!"
                exit 0
              fi
              echo "Waiting... ($i)"
              sleep 1
            done

            echo "❌ Deploy failed: app not responding at $APP_URL"
            docker compose logs --tail=50
            exit 1
