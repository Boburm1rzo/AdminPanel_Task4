name: Deploy to VPS

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m
          script_stop: true
          script: |
            set -euo pipefail

            SERVER_PATH="/root/projects/task4/AdminPanel_Task4/Task4/Task4"
            APP_URL="http://127.0.0.1:8080"

            cd "$SERVER_PATH"

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            docker compose up -d --build

            # small health check (up to 20s)
            for i in {1..20}; do
              if curl -fsS -I "$APP_URL" >/dev/null 2>&1; then
                echo "✅ Deployed successfully"
                exit 0
              fi
              sleep 1
            done

            echo "❌ Deploy failed: app not responding at $APP_URL"
            exit 1
